import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
const RATEHAWK_KEY_ID = Deno.env.get('RATEHAWK_KEY_ID');
const RATEHAWK_API_KEY = Deno.env.get('RATEHAWK_API_KEY');
const RATEHAWK_API_URL = Deno.env.get('RATEHAWK_API_URL') || 'https://api.worldota.net';
const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS'
};
async function logApiCall(supabase, endpoint, requestData, responseData, responseStatus, startTime, error) {
  const responseTime = Date.now() - startTime;
  try {
    await supabase.from('ratehawk_api_logs').insert({
      endpoint,
      method: 'POST',
      request_data: requestData,
      response_data: responseData,
      response_status: responseStatus,
      response_time_ms: responseTime,
      error: error || null
    });
  } catch (logError) {
    console.error('Failed to log API call:', logError);
  }
}
async function startBookingProcess(request, supabase) {
  const startTime = Date.now();
  const endpoint = '/api/b2b/v3/hotel/order/booking/finish/';
  // Build rooms array in RateHawk format
  const rooms = request.rooms.map((room)=>({
      guests: room.guests.map((guest)=>({
          first_name: guest.firstName,
          last_name: guest.lastName,
          is_child: guest.isChild || false,
          age: guest.age,
          gender: guest.gender
        }))
    }));
  const requestBody = {
    partner: {
      partner_order_id: request.partnerOrderId,
      comment: request.user.comment || ''
    },
    user: {
      email: request.user.email,
      phone: request.user.phone,
      comment: request.user.comment || ''
    },
    language: request.language || 'en',
    rooms: rooms,
    payment_type: {
      type: request.paymentType.type,
      amount: request.paymentType.amount,
      currency_code: request.paymentType.currencyCode
    }
  };
  // Add optional fields
  if (request.arrivalTime) {
    requestBody.arrival_datetime = request.arrivalTime;
  }
  if (request.supplierData) {
    requestBody.supplier_data = {
      first_name_original: request.supplierData.firstName,
      last_name_original: request.supplierData.lastName,
      phone: request.supplierData.phone,
      email: request.supplierData.email
    };
  }
  console.log(`[Booking Finish] Partner Order ID: ${request.partnerOrderId}`);
  console.log(`[Booking Finish] Rooms: ${request.rooms.length}`);
  console.log(`[Booking Finish] Total Guests: ${request.rooms.reduce((sum, r)=>sum + r.guests.length, 0)}`);
  try {
    const authString = `${RATEHAWK_KEY_ID}:${RATEHAWK_API_KEY}`;
    const encodedAuth = btoa(authString);
    const response = await fetch(`${RATEHAWK_API_URL}${endpoint}`, {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${encodedAuth}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    const data = await response.json();
    await logApiCall(supabase, endpoint, requestBody, data, response.status, startTime, response.ok ? undefined : 'API Error');
    if (!response.ok) {
      console.error('[Booking Finish] API Error:', data);
      throw new Error(data.error?.message || JSON.stringify(data));
    }
    console.log(`[Booking Finish] Success: Status ${data.status}`);
    return formatBookingFinishResponse(data, request);
  } catch (error) {
    console.error('[Booking Finish] Error:', error);
    await logApiCall(supabase, endpoint, requestBody, null, 0, startTime, error.message);
    throw error;
  }
}
function formatBookingFinishResponse(rawData, request) {
  const hasError = rawData.error !== null && rawData.error !== undefined;
  if (hasError) {
    return {
      success: false,
      error: {
        code: rawData.error,
        message: getErrorMessage(rawData.error),
        status: rawData.status
      },
      _rawResponse: rawData
    };
  }
  return {
    success: true,
    status: rawData.status,
    // Booking is now processing
    message: 'Booking process started. Use status check to monitor progress.',
    partnerOrderId: request.partnerOrderId,
    // Next step instruction
    nextStep: 'Poll status endpoint every 1-2 seconds until complete',
    _rawResponse: rawData
  };
}
function getErrorMessage(errorCode) {
  const errorMessages = {
    'invalid_params': 'Invalid parameters in request.',
    'order_not_found': 'Order not found. Create booking form first.',
    'timeout': 'Request timeout. Try again.',
    'unknown': 'Unknown error. Try again.'
  };
  return errorMessages[errorCode] || 'Unknown error occurred';
}
serve(async (req)=>{
  if (req.method === 'OPTIONS') {
    return new Response('ok', {
      headers: corsHeaders
    });
  }
  try {
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
    const request = await req.json();
    console.log('[Booking Finish] Received request');
    // Validation
    if (!request.partnerOrderId) {
      throw new Error('partnerOrderId is required');
    }
    if (!request.user?.email || !request.user?.phone) {
      throw new Error('user.email and user.phone are required');
    }
    if (!request.rooms || request.rooms.length === 0) {
      throw new Error('At least one room with guests is required');
    }
    // Validate each room has guests
    request.rooms.forEach((room, idx)=>{
      if (!room.guests || room.guests.length === 0) {
        throw new Error(`Room ${idx + 1} must have at least one guest`);
      }
      room.guests.forEach((guest, guestIdx)=>{
        if (!guest.firstName || !guest.lastName) {
          throw new Error(`Room ${idx + 1}, Guest ${guestIdx + 1} must have firstName and lastName`);
        }
      });
    });
    if (!request.paymentType) {
      throw new Error('paymentType is required');
    }
    const result = await startBookingProcess(request, supabase);
    return new Response(JSON.stringify(result), {
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      },
      status: 200
    });
  } catch (error) {
    console.error('[Booking Finish] Handler error:', error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      details: error.toString()
    }), {
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      },
      status: 500
    });
  }
});
