import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
const RATEHAWK_KEY_ID = Deno.env.get('RATEHAWK_KEY_ID');
const RATEHAWK_API_KEY = Deno.env.get('RATEHAWK_API_KEY');
const RATEHAWK_API_URL = Deno.env.get('RATEHAWK_API_URL') || 'https://api.worldota.net';
const SUPABASE_URL = Deno.env.get('SUPABASE_URL');
const SUPABASE_SERVICE_ROLE_KEY = Deno.env.get('SUPABASE_SERVICE_ROLE_KEY');
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'POST, OPTIONS'
};
async function logApiCall(supabase, endpoint, requestData, responseData, responseStatus, startTime, error) {
  const responseTime = Date.now() - startTime;
  try {
    await supabase.from('ratehawk_api_logs').insert({
      endpoint,
      method: 'POST',
      request_data: requestData,
      response_data: responseData,
      response_status: responseStatus,
      response_time_ms: responseTime,
      error: error || null
    });
  } catch (logError) {
    console.error('Failed to log API call:', logError);
  }
}
async function checkBookingStatus(request, supabase) {
  const startTime = Date.now();
  const endpoint = '/api/b2b/v3/hotel/order/booking/finish/status/';
  const requestBody = {
    partner_order_id: request.partnerOrderId
  };
  console.log(`[Booking Status] Checking: ${request.partnerOrderId}`);
  try {
    const authString = `${RATEHAWK_KEY_ID}:${RATEHAWK_API_KEY}`;
    const encodedAuth = btoa(authString);
    const response = await fetch(`${RATEHAWK_API_URL}${endpoint}`, {
      method: 'POST',
      headers: {
        'Authorization': `Basic ${encodedAuth}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(requestBody)
    });
    const data = await response.json();
    await logApiCall(supabase, endpoint, requestBody, data, response.status, startTime, response.ok ? undefined : 'API Error');
    if (!response.ok) {
      console.error('[Booking Status] API Error:', data);
      throw new Error(data.error?.message || JSON.stringify(data));
    }
    const percent = data.data?.percent || 0;
    console.log(`[Booking Status] Progress: ${percent}%`);
    return formatStatusResponse(data, request);
  } catch (error) {
    console.error('[Booking Status] Error:', error);
    await logApiCall(supabase, endpoint, requestBody, null, 0, startTime, error.message);
    throw error;
  }
}
function formatStatusResponse(rawData, request) {
  const statusData = rawData.data;
  const hasError = rawData.error !== null && rawData.error !== undefined;
  if (hasError) {
    return {
      success: false,
      status: 'error',
      isComplete: true,
      error: {
        code: rawData.error,
        message: getErrorMessage(rawData.error),
        status: rawData.status
      },
      _rawResponse: rawData
    };
  }
  const percent = statusData?.percent || 0;
  const isComplete = percent === 100;
  const isProcessing = percent > 0 && percent < 100;
  // Determine final status
  let finalStatus;
  if (rawData.status === 'ok' && percent === 100) {
    finalStatus = 'confirmed';
  } else if (hasError) {
    finalStatus = 'failed';
  } else {
    finalStatus = 'processing';
  }
  return {
    success: !hasError,
    status: finalStatus,
    isComplete: isComplete,
    isProcessing: isProcessing,
    progress: {
      percent: percent,
      message: getProgressMessage(percent)
    },
    partnerOrderId: request.partnerOrderId,
    // 3DS data if present
    requiresAuth: statusData?.data_3ds !== null,
    authData: statusData?.data_3ds || null,
    // Next action
    nextAction: isComplete ? 'Booking complete! No further action needed.' : 'Continue polling every 1-2 seconds until percent reaches 100',
    _rawResponse: rawData
  };
}
function getProgressMessage(percent) {
  if (percent === 0) return 'Initializing booking...';
  if (percent < 25) return 'Contacting hotel supplier...';
  if (percent < 50) return 'Processing reservation...';
  if (percent < 75) return 'Confirming availability...';
  if (percent < 100) return 'Finalizing booking...';
  return 'Booking confirmed!';
}
function getErrorMessage(errorCode) {
  const errorMessages = {
    'order_not_found': 'Booking not found. Check partner_order_id.',
    'invalid_params': 'Invalid parameters in request.',
    'timeout': 'Request timeout. Try again.',
    'unknown': 'Unknown error. Try again.'
  };
  return errorMessages[errorCode] || 'Unknown error occurred';
}
serve(async (req)=>{
  if (req.method === 'OPTIONS') {
    return new Response('ok', {
      headers: corsHeaders
    });
  }
  try {
    const supabase = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY);
    const request = await req.json();
    console.log('[Booking Status] Received request');
    // Validation
    if (!request.partnerOrderId) {
      throw new Error('partnerOrderId is required');
    }
    const result = await checkBookingStatus(request, supabase);
    return new Response(JSON.stringify(result), {
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      },
      status: 200
    });
  } catch (error) {
    console.error('[Booking Status] Handler error:', error);
    return new Response(JSON.stringify({
      success: false,
      error: error.message,
      details: error.toString()
    }), {
      headers: {
        ...corsHeaders,
        'Content-Type': 'application/json'
      },
      status: 500
    });
  }
});
